<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Map</title>
    <link rel="stylesheet" href="css/leaflet.css">
    <script src="lib/leaflet.js"></script>
    <script src="lib/d3.min.js"></script>
    <!-- <script src="lib/leaflet.edgebuffer.js"></script> -->
</head>

<style>
    html,
    body {
        height: 100%;
        margin: 0;
    }

    #map {
        height: 100%;
    }

    /* 底图的颜色和透明度 */
    /* .leaflet-container .leaflet-tile-pane img {
        filter: grayscale(1)opacity(0.3);
    } */

    .leaflet-zoom-anim .leaflet-zoom-animated {
        transition: 2s;
    }
</style>

<body>
    <div id="map"></div>
</body>

<script>
    var data, map, tile, pointWidth;

    //用颜色来区分类别
    var colorScale = {
        '已建成': '#B6A6CA',
        '未建成': '#6D98BA'
    };

    //用 ICON 来区分类别
    var iconType = {
        '已建成': 'marker/icon1.png',
        '未建成': 'marker/icon2.png'
    };

    //函数1：地图初始化
    function initMap() {
        //加载地图
        map = L.map('map', {
            smoothZoom: true,
            smoothZoomDelay: 1000 //Default to 1000
        });

        //加载地图瓦片（皮肤）
        tile = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri',
            maxZoom: 13
        });

        //把皮肤添加到地图模块
        tile.addTo(map);
        //设置初始视点 纬度/经度/缩放等级
        map.setView([20, 0], 3);
    }

    //函数2：读取数据
    function getData() {
        //用 D3 加载数据
        d3.csv('data/lecorbusier.csv')
            .then(function (csv) {
                //用 csv 文件里的数据给我们声明的变量赋值
                data = csv;
                // pointWidth = d.latitude;
                //调用 addMarkers 函数，把点画在地图上
                addMarkers();
            });
    }

    //设置自定义图标的属性
    var LeafIcon = L.Icon.extend({
        options: {
            // shadowUrl: 'marker/leaf-shadow.png',
            iconSize: [20, 20],//icon 大小
            iconAnchor: [0, 10],//图标的标记点
            // shadowSize: [50, 64],//阴影大小
            // shadowAnchor: [4, 62],//阴影的标记点
            popupAnchor: [10, -10]//工具提示的标记点
        }
    });

    //函数3：遍历数据点，画出标志
    function addMarkers() {
        data.forEach(function (d) {
            
            //用不同的 icon 区分点
            // var iconPic = new LeafIcon({ iconUrl: iconType[d.category] });
            // var marker = L.marker([+d.latitude, +d.longitude], { icon: iconPic });

            //用不同的颜色区分点
            var marker = L.circleMarker([+d.latitude, +d.longitude]);
            var color = colorScale[d.category] || '#aaa';
            var pointRadius = +d.latitude / 2;
            console.log(pointRadius)
            marker.setStyle({
                radius: pointRadius,//尺寸大小
                fillColor: color,//填充颜色
                fillOpacity: 1,//透明度
                color: 'blue',//描边颜色
                weight: 3//描边宽度
            });

            //添加marker 到地图
            marker.addTo(map).bindPopup(d.work);
        })
    }


    //加载 initMap 函数
    initMap();
    getData();

    //点击数据点自动缩放地图
    map.on("popupopen", function (centerMarker) {
        const zoomLvl = 4;
        var cM = map.project(centerMarker.popup._latlng);
        cM.y -= centerMarker.popup._container.clientHeight / 3;
        map.setView(map.unproject(cM), zoomLvl, {
            animate: true,
            pan: {
                duration: 0.5
            }
        });
    });

</script>

</html>